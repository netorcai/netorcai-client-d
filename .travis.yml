language: nix
nix: 2.1.1

script:
  # install netorcai
  - nix-env -f https://github.com/netorcai/pkgs/archive/master.tar.gz -iA netorcai
  - netorcai --version

  # install dmd and dub
  - nix-env -f https://github.com/NixOS/nixpkgs/archive/18.09.tar.gz -iA dmd dub
  - dmd --version
  - dub --version

  # run unit tests with coverage
  - make unittest-cov

  # delete non-interesting coverage results
  - find . -name '*.lst' | grep 'dub_test' | sed -E "s/(.*)/rm -f -- '\1'/" | bash

  # install doveralls and send coverage results with it
  - nix-shell -p wget --command 'wget -O ./doveralls "https://github.com/ColdenCullen/doveralls/releases/download/v1.3.1/doveralls_linux_travis"'
  - chmod +x ./doveralls
  - ./doveralls
